
# MOEX Bot Backtester (H1, VWAP-revert, Risk Controls)

Готовый минималистичный каркас для бэктеста с реализацией:
- **Intraday VWAP-revert (H1)** — сигнал mean-reversion к VWAP.
- **Волатильностное таргетирование** (0.5%/день по портфелю, параметризуемо).
- **Hard Stop-Loss по портфелю**: дневной (-2%) и общий (-10%) лимиты.
- **Circuit Breaker**: после N убыточных сделок подряд — запрет новых позиций в этот день (или снижение объема).
- **Честная модель издержек**: комиссия, спред (целый), проскальзывание в шагах цены.
- **Режимы рынка** (Low/Medium/High) по ATR с разной агрессивностью.
- **Политика "новые позиции запрещены"** — в конфиге `NEW_POSITIONS_ENABLED=False` (для первых тестов).

## Структура
```
app/
  backtest_run.py        # Точка входа
  config.py              # Параметры и политика
  data_loader.py         # Загрузка H1 CSV (по тикерам)
  engine.py              # Простой батчер по барам + исполнение
  costs.py               # Комиссии, спред, проскальзывание
  indicators.py          # ATR, VWAP, волатильность
  regime.py              # Определение режимов (low/med/high)
  risk_manager.py        # Волатильностное таргетирование, портфельные стопы, circuit breaker
  strategy_vwap_revert.py# Логика сигналов VWAP-revert + time-stop/ATR-stop
  utils.py               # Утилиты
data/
  SBER.csv               # (положите данные сюда) H1 с колонками datetime,open,high,low,close,volume
  ...
```

### Формат данных
CSV на H1 с колонками:
```
datetime,open,high,low,close,volume
2024-01-15 10:00:00,100,101,99,100.5,123456
...
```
Временная зона не критична, важен **монотонный** индекс и единый таймфрейм H1.

### Запуск
```bash
python -m app.backtest_run
```

### Параметры по умолчанию
- Тикеры: `SBER, GAZP, LKOH, GMKN, YDEX, ROSN`
- Таймфрейм: H1 (ожидаются H1 csv)
- Стратегия: Intraday VWAP-revert (rolling VWAP по N=6 баров)
- Target portfolio daily risk: 0.5% (и таргетирование по волатильности инструмента)
- Портфельные стопы: дневной -2%, общий -10%
- Circuit breaker: 3 лосса подряд — запрет новых позиций до конца дня
- Политика новых позиций: **запрещено** (смените в `config.py` на `True`, когда будете готовы)

### Примечания по издержкам
- Комиссия задается как **per-side** (за вход/выход). В сумме за круг ~0.06%.
- Спред закладывается как **целый** за круг: реализация — 0.5*spread в неблаг. сторону на каждой стороне.
- Проскальзывание — N шагов цены (tick_size) по каждой стороне.

Если стратегия не выживает с такой моделью издержек — она не выживет в реальности.

### Что дальше
1. Запустите бэктест и убедитесь, что **портфельные стопы** и **политика запрета позиций** работают.
2. Включите NEW_POSITIONS_ENABLED, как только убедитесь в корректности стопов.
3. Итеративно подбирайте параметры VWAP окна, time-stop, ATR-множители и прайсы рисков.

