"""
–°–ò–°–¢–ï–ú–ê –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –ü–ï–†–ï–ù–û–°–ê –°–û–°–¢–û–Ø–ù–ò–Ø –ü–†–û–ï–ö–¢–ê
"""
from datetime import datetime
import json
import pandas as pd
from pathlib import Path
from .paths import REPORTS_DIR


class ProjectStateTransfer:
    def __init__(self):
        self.transfer_dir = REPORTS_DIR / 'transfer'
        self.transfer_dir.mkdir(exist_ok=True)

        self.auto_report_path = self.transfer_dir / 'AUTO_REPORT.md'
        self.state_file = self.transfer_dir / 'project_state.json'

    def generate_auto_report(self, latest_results: dict = None, current_experiment: str = ""):
        """–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ—Ç—á–µ—Ç–∞"""

        report = f"""
# ü§ñ MOEX AI BOT - AUTOMATED TRANSFER REPORT
**Generated:** {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

## üìä –ü–û–°–õ–ï–î–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´ –ë–≠–ö–¢–ï–°–¢–ê
{self._format_results(latest_results)}

## üî¨ –¢–ï–ö–£–©–ò–ô –≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢
{current_experiment}

## üéØ –ü–†–ò–û–†–ò–¢–ï–¢–ù–´–ï –ó–ê–î–ê–ß–ò
{self._get_priority_tasks()}

## üìù –ò–°–¢–û–†–ò–Ø –≠–ö–°–ü–ï–†–ò–ú–ï–ù–¢–û–í
{self._get_experiment_history()}

## üêõ –ò–ó–í–ï–°–¢–ù–´–ï –ü–†–û–ë–õ–ï–ú–´
{self._get_known_issues()}

## üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –î–õ–Ø –ü–†–û–î–û–õ–ñ–ï–ù–ò–Ø
{self._get_continuation_recommendations()}

---
*Auto-generated by transfer_system.py*
"""

        with open(self.auto_report_path, 'w', encoding='utf-8') as f:
            f.write(report)

        print(f"‚úÖ –ê–≤—Ç–æ–æ—Ç—á–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω: {self.auto_report_path}")

    def save_project_state(self, state_data: dict):
        """–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞"""
        state_data['last_updated'] = datetime.now().isoformat()
        state_data['token_usage_alert'] = "95_PERCENT"  # –∏–ª–∏ "NORMAL"

        with open(self.state_file, 'w', encoding='utf-8') as f:
            json.dump(state_data, f, indent=2, ensure_ascii=False)

    def load_project_state(self) -> dict:
        """–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–∞"""
        if self.state_file.exists():
            with open(self.state_file, 'r', encoding='utf-8') as f:
                return json.load(f)
        return {}

    def _format_results(self, results: dict) -> str:
        if not results:
            return "```json\n{}\n```"

        formatted = []
        for symbol, metrics in results.items():
            formatted.append(f"- **{symbol}**: {metrics.get('total_trades', 0)} —Å–¥–µ–ª–æ–∫, "
                             f"WR: {metrics.get('win_rate', 0):.1%}, "
                             f"Return: {metrics.get('total_return', 0):.2%}")

        return "\n".join(formatted) if formatted else "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö"

    def _get_priority_tasks(self):
        return """
1. **üö® URGENT**: –ü–æ—á–∏–Ω–∏—Ç—å –≥–µ–Ω–µ—Ä–∞—Ü–∏—é —Å–∏–≥–Ω–∞–ª–æ–≤ (0 —Å–¥–µ–ª–æ–∫)
2. **üîß HIGH**: –í–Ω–µ–¥—Ä–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π  
3. **üìà MEDIUM**: –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Ä–µ–∂–∏–º–Ω—É—é –ª–æ–≥–∏–∫—É –¥–æ VOLA+TREND —è–¥—Ä–∞
4. **‚ö° LOW**: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å —á–∞—Å—Ç–æ—Ç–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç–µ–ª–∏
"""

    def _get_experiment_history(self):
        return """
- 2025-11-11: –ü–µ—Ä–≤–∞—è —Ä–µ–∂–∏–º–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è - 0 —Å–¥–µ–ª–æ–∫
- 2025-11-11: –ü–æ–Ω–∏–∂–µ–Ω—ã –ø–æ—Ä–æ–≥–∏ –≤ dynamic_regime_detector
- 2025-11-11: –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö
- 2025-11-11: –°–æ–∑–¥–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä–µ–Ω–æ—Å–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è
"""

    def _get_known_issues(self):
        return """
- ‚ùå regime_backtest –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0 —Å–¥–µ–ª–æ–∫
- ‚ö†Ô∏è –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º —Ñ–∏—á GB –º–æ–¥–µ–ª–∏
- üîç –°–ª–∏—à–∫–æ–º –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã –≤ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è—Ö
"""

    def _get_continuation_recommendations(self):
        return """
- –ù–∞—á–∞—Ç—å —Å emergency_debug_strategy –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–µ—Ä–≤—ã—Ö —Å–¥–µ–ª–æ–∫
- –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å–ª–µ —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å transfer_system –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
"""